{"version":3,"file":"portal-module.registry.js","sourceRoot":"ng://@codethatstack/portals/","sources":["lib/portal-module.registry.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, NgModuleRef, Injector, Compiler, NgModuleFactoryLoader, NgModuleFactory, Optional, Inject } from '@angular/core';\r\nimport { Observable, isObservable, from, of } from 'rxjs';\r\nimport { map, tap, switchMap } from 'rxjs/operators';\r\nimport { ModuleLoaderDef, ModuleRegistryType, PORTAL_MODULE_TOKEN } from './portal-types';\r\n\r\n@Injectable({ providedIn: 'root' })\r\nexport class PortalModuleRegistry {\r\n\r\n  private _registry = new Map<string, ModuleLoaderDef>();\r\n  private _cache = new Map<string, any>();\r\n\r\n  constructor(\r\n    @Optional() @Inject(PORTAL_MODULE_TOKEN) lazyModules: ModuleLoaderDef[],\r\n    private injector: Injector,\r\n    private compiler: Compiler,\r\n    @Optional() private moduleLoader: NgModuleFactoryLoader) {\r\n\r\n    if (lazyModules != null) {\r\n      this.register(lazyModules);\r\n    }\r\n  }\r\n\r\n  public register(moduleLoaderDefs: ModuleLoaderDef[]): void {\r\n    moduleLoaderDefs.forEach(value => {\r\n      this._registry.set(value.moduleId, value);\r\n    });\r\n  }\r\n\r\n  public getOrLoad(moduleDef: ModuleRegistryType, localInjector?: Injector): Observable<NgModuleRef<any>> {\r\n    return new Observable(subscriber => {\r\n      if (moduleDef instanceof NgModuleRef) {\r\n        subscriber.next(moduleDef);\r\n        subscriber.complete();\r\n        return;\r\n      }\r\n\r\n      const moduleId = this.getModuleId(moduleDef);\r\n      const moduleReference = this._cache.get(moduleId);\r\n\r\n      if (moduleReference != null) {\r\n        if (isObservable(moduleReference)) {\r\n          moduleReference.subscribe(subscriber);\r\n        } else {\r\n          subscriber.next(moduleReference);\r\n          subscriber.complete();\r\n        }\r\n        return;\r\n      }\r\n\r\n      let loader$: Observable<NgModuleFactory<any>>;\r\n\r\n      if (typeof moduleDef === 'string') {\r\n\r\n        const registryValue = this._registry.get(moduleDef);\r\n        if (registryValue == null) {\r\n          subscriber.error(`No NgModule module loader specified for ${moduleDef}`);\r\n          return;\r\n        }\r\n\r\n        loader$ = from(registryValue.load())\r\n          .pipe(\r\n            switchMap(moduleOrFactory => {\r\n              if (moduleOrFactory instanceof NgModuleFactory) {\r\n                return of(moduleOrFactory);\r\n              }\r\n              return from(this.compiler.compileModuleAsync(moduleOrFactory));\r\n            }),\r\n          );\r\n\r\n      } else {\r\n        /** Deprecated */\r\n        const pathAndModule = `${moduleDef['path']}#${moduleDef['name']}`;\r\n        loader$ = from(this.moduleLoader.load(pathAndModule));\r\n      }\r\n\r\n      const factory$ = loader$.pipe(\r\n          map((factory: NgModuleFactory<any>) => factory.create(localInjector || this.injector)),\r\n          tap(ngModuleRef => this._cache.set(moduleId, ngModuleRef)));\r\n\r\n      this._cache.set(moduleId, factory$);\r\n      factory$.subscribe(v => subscriber.next(v));\r\n    });\r\n  }\r\n\r\n  private getModuleId(moduleDef: ModuleRegistryType): string {\r\n    if (typeof moduleDef === 'string') {\r\n      return moduleDef;\r\n    }\r\n    return moduleDef['moduleId'] ?? moduleDef['name'];\r\n  }\r\n\r\n}"]}